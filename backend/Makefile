# MoneyMatch Backend - Makefile
# Comandos Ãºtiles para desarrollo con Supabase

.PHONY: help install start stop restart status reset logs db-reset db-migrate db-rollback db-seed types clean check

# Variables
SUPABASE_DIR = ./supabase

# Comando por defecto
help: ## Mostrar ayuda
	@echo "MoneyMatch Backend - Comandos disponibles:"
	@echo ""
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# === CONFIGURACIÃ“N INICIAL ===
install: ## Instalar dependencias y configurar proyecto
	@echo "ğŸ”§ Configurando proyecto..."
	@supabase --version || { echo "âŒ Supabase CLI no estÃ¡ instalado. InstÃ¡lalo con: npm install -g supabase"; exit 1; }
	@echo "âœ… Supabase CLI encontrado"
	@echo "ğŸš€ Proyecto configurado correctamente"

# === SERVICIOS LOCALES ===
start: ## Iniciar servicios locales de Supabase
	@echo "ğŸš€ Iniciando servicios locales de Supabase..."
	cd $(SUPABASE_DIR) && supabase start

stop: ## Detener servicios locales de Supabase
	@echo "ğŸ›‘ Deteniendo servicios locales de Supabase..."
	cd $(SUPABASE_DIR) && supabase stop

restart: ## Reiniciar servicios locales de Supabase
	@echo "ğŸ”„ Reiniciando servicios locales de Supabase..."
	cd $(SUPABASE_DIR) && supabase stop && supabase start

status: ## Mostrar estado de los servicios
	@echo "ğŸ“Š Estado de los servicios:"
	cd $(SUPABASE_DIR) && supabase status

# === BASE DE DATOS ===
db-reset: ## Resetear base de datos local
	@echo "ğŸ—‘ï¸  Reseteando base de datos local..."
	cd $(SUPABASE_DIR) && supabase db reset

db-migrate: ## Aplicar migraciones pendientes
	@echo "ğŸ”„ Aplicando migraciones..."
	cd $(SUPABASE_DIR) && supabase migration up

db-rollback: ## Revertir Ãºltima migraciÃ³n
	@echo "âª Revirtiendo Ãºltima migraciÃ³n..."
	cd $(SUPABASE_DIR) && supabase migration down

db-seed-db: ## Ejecutar seeds de datos de prueba
	@echo "ğŸŒ± Ejecutando seed de usuarios y datos de prueba..."
	pnpm run seed-db
	@echo "âœ… Seed de usuarios ejecutado"

db-init-mvp-from-migrations: ## Inicializar tablas MVP desde migraciones
	@echo "Reseteando base de datos..."
	cd $(SUPABASE_DIR) && supabase db reset
	@echo "ğŸ’ƒ Iniciando tablas MVP con RLS..."
	cd $(SUPABASE_DIR) && supabase db push --local
	@echo "âœ… InicializaciÃ³n completada"

# === MIGRACIONES ===
migration-new: ## Crear nueva migraciÃ³n (usar: make migration-new name=nombre_migracion)
	@if [ -z "$(name)" ]; then \
		echo "âŒ Error: Especifica el nombre de la migraciÃ³n"; \
		echo "Uso: make migration-new name=nombre_migracion"; \
		exit 1; \
	fi
	@echo "ğŸ“ Creando nueva migraciÃ³n: $(name)"
	cd $(SUPABASE_DIR) && supabase migration new $(name)

migration-diff: ## Generar migraciÃ³n desde diferencias en schema
	@echo "ğŸ” Generando migraciÃ³n desde diferencias..."
	cd $(SUPABASE_DIR) && supabase db diff --schema public

# === TIPOS Y CÃ“DIGO ===
types: ## Generar tipos Swift
	@echo "ğŸ”§ Generando tipos..."
	cd $(SUPABASE_DIR) && supabase gen types --local --lang=swift > database.types.swift
	@echo "âœ… Tipos generados en database.types.swift"

# === DESARROLLO ===
logs: ## Mostrar logs de servicios locales
	@echo "ğŸ“‹ Mostrando logs..."
	cd $(SUPABASE_DIR) && supabase logs

# === LIMPIEZA ===
clean: ## Limpiar archivos temporales
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	cd $(SUPABASE_DIR) && rm -rf .temp/*
	@echo "âœ… Limpieza completada"

reset: ## Reset completo del proyecto
	@echo "ğŸ”„ Realizando reset completo del proyecto..."
	cd $(SUPABASE_DIR) && supabase stop
	cd $(SUPABASE_DIR) && supabase db reset
	cd $(SUPABASE_DIR) && supabase start
	@echo "âœ… Reset completo terminado"

# === VALIDACIÃ“N ===
check: ## Verificar configuraciÃ³n del proyecto
	@echo "âœ… Verificando configuraciÃ³n..."
	@supabase --version || { echo "âŒ Supabase CLI no instalado"; exit 1; }
	@echo "âœ… Supabase CLI: OK"
	@test -f $(SUPABASE_DIR)/config.toml || { echo "âŒ config.toml no encontrado"; exit 1; }
	@echo "âœ… ConfiguraciÃ³n: OK"
	@test -d $(SUPABASE_DIR)/migrations || { echo "âŒ Directorio migrations no encontrado"; exit 1; }
	@echo "âœ… Migraciones: OK"
	@echo "ğŸ‰ Proyecto configurado correctamente"

db-init-and-seed: ## Inicializar tablas MVP desde migraciones y ejecutar seed de datos de prueba
	@echo "ğŸŒ± Inicializando tablas MVP desde migraciones..."
	make db-init-mvp-from-migrations
	@echo "ğŸŒ± Ejecutando seed de datos de prueba..."
	make db-seed-db
	@echo "âœ… InicializaciÃ³n y seed completados"